#Requires -RunAsAdministrator
<#
.SYNOPSIS
    WinAuto Log Viewer
.DESCRIPTION
    Scans for and displays the most recent logs generated by the WinAuto suite.
#>

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

# --- SHARED FUNCTIONS ---
. "$PSScriptRoot\..\Shared\Shared_UI_Functions.ps1"

# --- LOG LOGIC ---
function Get-RecentLog {
    param($PathPattern)
    $file = Get-ChildItem $PathPattern -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
    return $file
}

function Show-LogContent {
    param($File)
    if (-not $File) { 
        Write-Host "  No log file found." -ForegroundColor Red
        return 
    }

    Write-Header "VIEWING LOG: $($File.Name)"
    Write-Host ""
    $content = Get-Content $File.FullName
    if ($content.Count -gt 30) {
        $content | Select-Object -Last 30 | ForEach-Object { Write-Host "  $_" -ForegroundColor Gray }
        Write-Host "`n  ... (Showing last 30 lines) ..." -ForegroundColor Cyan
    } else {
        $content | ForEach-Object { Write-Host "  $_" -ForegroundColor Gray }
    }
    Write-Host ""
    Write-Boundary
    Write-Host "  Full Path: $($File.FullName)" -ForegroundColor DarkGray
    Write-Boundary
    
    # Simple scroll/pause
    $null = Wait-KeyPressWithTimeout -Seconds 10 -OnTick $TickAction
}

# --- MAIN LOOP ---
$running = $true
while ($running) {
    # Find Logs
    $logMaint = Get-RecentLog "$env:WinAutoLogDir\Maint_*.log"
    $logUpdate = Get-RecentLog "$env:WinAutoLogDir\Update_*.log"
    $logSecurity = Get-RecentLog "$env:WinAutoLogDir\Security_*.log"
    $logApp = Get-RecentLog "$($env:WinAutoLogDir)\App-Install-Summary-*.txt"

    Write-Header "LOG VIEWER"
    Write-Host ""
    
    # Menu Items
    Write-Host "  [1] Maintenance Log" -NoNewline
    if ($logMaint) { Write-Host " ($($logMaint.LastWriteTime.ToString('MM/dd HH:mm')))" -ForegroundColor DarkGray } else { Write-Host " (Not Found)" -ForegroundColor Red }
    
    Write-Host "  [2] Update Log" -NoNewline
    if ($logUpdate) { Write-Host "      ($($logUpdate.LastWriteTime.ToString('MM/dd HH:mm')))" -ForegroundColor DarkGray } else { Write-Host "      (Not Found)" -ForegroundColor Red }
    
    Write-Host "  [3] Security Log" -NoNewline
    if ($logSecurity) { Write-Host "    ($($logSecurity.LastWriteTime.ToString('MM/dd HH:mm')))" -ForegroundColor DarkGray } else { Write-Host "    (Not Found)" -ForegroundColor Red }
    
    Write-Host "  [4] App Install Log" -NoNewline
    if ($logApp) { Write-Host " ($($logApp.LastWriteTime.ToString('MM/dd HH:mm')))" -ForegroundColor DarkGray } else { Write-Host " (Not Found)" -ForegroundColor Red }
    
    Write-Host ""
    Write-Host "  [5] Clear Event Logs" -ForegroundColor Yellow
    
    Write-Host ""
    Write-Boundary
    $PromptCursorTop = [Console]::CursorTop
    $TickAction = {
        param($ElapsedTimespan)
        $WiggleFrame = [Math]::Floor($ElapsedTimespan.TotalMilliseconds / 500); $IsRight = ($WiggleFrame % 2) -eq 1
        $CurrentChars = if ($IsRight) { @(" ", $Char_Finger, "[", "E", "n", "t", "e", "r", "]", " ") } else { @($Char_Finger, " ", "[", "E", "n", "t", "e", "r", "]", " ") }
        $FilledCount = [Math]::Floor($ElapsedTimespan.TotalSeconds); if ($FilledCount -gt 10) { $FilledCount = 10 }
        $DynamicPart = ""
        for ($i = 0; $i -lt 10; $i++) {
            $Char = $CurrentChars[$i]
            if ($i -lt $FilledCount) { $DynamicPart += "${BGYellow}${FGBlack}$Char${Reset}" } else { $DynamicPart += if ($Char -eq " ") { " " } else { "${FGYellow}$Char${Reset}" } }
        }
        $p = "${FGWhite}$Char_Keyboard  Type${FGYellow} ID ${FGWhite}to View${FGWhite}|${FGDarkGray}or Press ${FGDarkGray}$DynamicPart${FGDarkGray}${FGWhite}to ${FGWhite}EXIT$Char_Eject${Reset}"
        try { [Console]::SetCursorPosition(0, $PromptCursorTop); Write-Centered $p } catch {}
    }
    
    $key = Wait-KeyPressWithTimeout -Seconds 10 -OnTick $TickAction
    Write-Host ""
    if ($key.VirtualKeyCode -eq 13) { $val = "EXIT" } else { $val = $key.Character.ToString() }
    
    switch ($val) {
        '1' { Show-LogContent $logMaint }
        '2' { Show-LogContent $logUpdate }
        '3' { Show-LogContent $logSecurity }
        '4' { Show-LogContent $logApp }
        '5' {

            Write-Header "CLEAR EVENT LOGS"
            Write-Host ""
            Write-Centered "$FGRed$Char_Warn Warning: This will delete system history logs.$Reset"
            $confirm = Read-Host "  Type 'CLEAR' to confirm"
            if ($confirm -eq 'CLEAR') {
                $Logs = @("System", "Application", "Security", "Setup")
                foreach ($log in $Logs) {
                    try {
                        Clear-EventLog -LogName $log -ErrorAction SilentlyContinue
                        Write-Host "  $FGGreen$Char_BallotCheck Cleared: $log$Reset"
                    } catch {
                        Write-Host "  $FGRed Failed: $log$Reset"
                    }
                }
                Start-Sleep -Seconds 2
            }
        }
        Default { $running = $false }
    }
}









