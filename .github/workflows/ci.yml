name: WinAuto Quality Audit

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  audit_scripts:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up PowerShell 5.1
      uses: actions/setup-powershell@v3
      with:
        powershell-version: '5.1' # Ensure we test on the required base version

    - name: Install Pester if not available
      shell: powershell
      run: |
        # Pester is usually included in PS 5.1+, but this ensures it's present
        if (-not (Get-Module -ListAvailable -Name Pester)) {
          Write-Host "Pester not found. Installing latest stable version..."
          Install-Module Pester -Force -SkipPublisherCheck -Scope CurrentUser
        } else {
          Write-Host "Pester already installed."
        }
        
    - name: Run Pester Tests
      shell: powershell
      run: |
        # Run the Pester tests from the tests/ directory
        $ErrorActionPreference = "Stop"
        
        Write-Host "Starting WinAuto Pester Audit..."
        
        try {
            # Invoke-Pester requires a specific path or it searches
            Invoke-Pester -Path ".\tests\*.Tests.ps1" -EnableExitCode 1
        } catch {
            Write-Error "Pester execution failed: $_"
            exit 1
        }
        Write-Host "Pester Audit completed."

